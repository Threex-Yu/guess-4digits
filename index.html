<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>çŒœæ•°å­—</title>

  <script>
    (function () {
      function makeRoomId() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let s = "";
        for (let i = 0; i < 6; i++) s += chars[Math.floor(Math.random() * chars.length)];
        return s;
      }
      const h = (location.hash || "").replace(/^#/, "");
      if (!/room=([a-zA-Z0-9_-]{4,32})/.test(h)) location.hash = "room=" + makeRoomId();
    })();
  </script>

  <style>
    :root{color-scheme:dark}
    body{margin:0;font-family:system-ui;background:#0f1115;color:#e7e9ee;display:grid;place-items:start center;min-height:100vh}
    .wrap{width:min(1200px,94vw);padding:22px 0 40px}
    h1{font-size:20px;margin:0 0 12px}
    .card{background:#151a22;border:1px solid #262c36;border-radius:14px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0f131b;border:1px solid #2a3140;font-size:13px}
    input,button{border-radius:10px;border:1px solid #2a3140;background:#0f131b;color:#e7e9ee;padding:10px 12px;font-size:14px;outline:none}
    input.small{width:190px}
    button{cursor:pointer;background:#1b2330;border-color:#344055}
    button.primary{background:#2a3a58;border-color:#415a85}
    button.danger{background:#3a1f25;border-color:#6b2a33}
    button.ghost{background:#0f131b;border-color:#2a3140}
    button.active{outline:2px solid rgba(126,231,135,.45)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .muted{opacity:.85;font-size:13px}
    .hr{height:1px;background:#262c36;margin:12px 0}
    .debug{margin-top:12px;padding:10px 12px;border:1px solid #2a3140;border-radius:10px;background:#0f131b;font-size:13px;opacity:.92;white-space:pre-wrap}

    .cols{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));margin-top:10px}
    .col{background:#0f131b;border:1px solid #2a3140;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:260px}
    .colHead{padding:10px 12px;border-bottom:1px solid #2a3140;display:flex;justify-content:space-between;gap:10px;font-size:13px;background:rgba(255,255,255,0.02)}
    .colHead .title{font-weight:650}
    .colHead .sub{opacity:.75;font-size:12px}
    .colBody{padding:10px 12px;overflow:auto;flex:1;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;white-space:pre-wrap;line-height:1.5}
    .ok{color:#7ee787}
    .cur{outline:2px solid rgba(126,231,135,.35)}

    /* âœ… èƒœåˆ©å¼¹çª—ï¼ˆå¤§å­—å·ã€å±å¹•ä¸­å¤®ï¼‰ */
    .modalMask{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(640px,92vw);
      background:#0f131b;
      border:1px solid #2a3140;
      border-radius:16px;
      padding:26px 22px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      text-align:center;
    }
    .modalTitle{
      font-size:42px; line-height:1.15; font-weight:800;
      margin:0 0 10px;
    }
    .modalSub{
      font-size:18px; opacity:.85; margin:0 0 18px;
    }
    .modalBtn{
      padding:10px 18px; font-size:15px; border-radius:12px;
      background:#2a3a58; border:1px solid #415a85; color:#e7e9ee;
      cursor:pointer;
    }
  </style>

  <script src="./supabase.js"></script>

  <script defer>
  (() => {
    const SUPABASE_URL = "https://yugpntcbnxgqgfcupewi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_9rpn0QDQOxqyrpOX7zZWNA_JNiXVlu_";

    const digitsOnly = (s)=>(s||"").replace(/\D/g,"");
    function isNDigits(s, n){ return new RegExp(`^\\d{${n}}$`).test(s); }
    function scoreExactN(target, guess){
      const n = Math.min(target.length, guess.length);
      let c=0;
      for(let i=0;i<n;i++) if(target[i]===guess[i]) c++;
      return c;
    }
    function getRoomIdFromHash(){
      const h = (location.hash || "").replace(/^#/, "");
      const m = h.match(/room=([a-zA-Z0-9_-]{4,32})/);
      return m ? m[1] : null;
    }
    function padNum(num, n){
      return String(num).padStart(n, "0");
    }
    function randDigits(n){
      let s="";
      for(let i=0;i<n;i++) s += Math.floor(Math.random()*10);
      return s;
    }

    window.__copyRoomLink = () => prompt("å¤åˆ¶ä¸‹é¢é“¾æ¥å‘ç»™æœ‹å‹ï¼š", location.href);
    window.__leaveRoom = () => location.reload();
    window.__joinRoom = () => alert("é¡µé¢è¿˜åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨ç­‰");
    window.__setSecret = () => alert("é¡µé¢è¿˜åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨ç­‰");
    window.__startGame = () => alert("é¡µé¢è¿˜åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨ç­‰");
    window.__resetRoom = () => alert("é¡µé¢è¿˜åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨ç­‰");
    window.__submitGuess = () => alert("é¡µé¢è¿˜åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨ç­‰");
    window.__setDigits = (n) => alert("é¡µé¢è¿˜åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨ç­‰");
    window.__addBot = () => alert("é¡µé¢è¿˜åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨ç­‰");
    window.__setBotLevel = (lv) => alert("é¡µé¢è¿˜åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨ç­‰");

    document.addEventListener("DOMContentLoaded", async () => {
      const $ = (s)=>document.querySelector(s);
      const setDebug = (msg)=>{ $("#debugBar").textContent = "debug: " + msg; };
      const addDebug = (msg)=>{ $("#debugBar").textContent += "\n" + msg; };
      const setLobby = (msg)=>{ $("#lobbyInfo").textContent = msg; };

      // å¼¹çª—
      const showModal = (title, sub="") => {
        $("#modalTitle").textContent = title;
        $("#modalSub").textContent = sub || "";
        $("#modalMask").style.display = "flex";
      };
      const hideModal = () => { $("#modalMask").style.display = "none"; };
      $("#modalOk").onclick = hideModal;
      $("#modalMask").addEventListener("click", (e)=>{ if(e.target.id==="modalMask") hideModal(); });

      const room_id = getRoomIdFromHash();
      const roomUrl = `${location.origin}${location.pathname}#room=${room_id}`;

      $("#roomPill").textContent = `Room: ${room_id}`;
      $("#joinHint").textContent = `æˆ¿é—´é“¾æ¥ï¼š${roomUrl}`;
      $("#joinHint").style.userSelect = "text";

      $("#copyLinkBtn").onclick = window.__copyRoomLink;
      $("#leaveBtn").onclick = window.__leaveRoom;

      setLobby("é¡µé¢å·²åŠ è½½ã€‚ä¸‹ä¸€æ­¥ï¼šè¾“å…¥åå­— â†’ åŠ å…¥æˆ¿é—´ã€‚");
      setDebug("ä¸»è„šæœ¬å·²è¿è¡Œ âœ…");

      let sb = null;
      try{
        if(!window.supabase) throw new Error("window.supabase is nullï¼ˆSDK æœªåŠ è½½ï¼‰");
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        $("#statusPill").textContent = "Status: SDK OK";
        addDebug("SDK OK âœ…");
      }catch(e){
        console.error(e);
        $("#statusPill").textContent = "Status: SDK FAILED";
        addDebug("SDK FAILED âŒ: " + (e?.message || e));
        setLobby("âŒ Supabase åˆå§‹åŒ–å¤±è´¥ï¼šçœ‹æ§åˆ¶å°ã€‚");
        return;
      }

      let me_id = localStorage.getItem(`me_player_id:${room_id}`) || "";
      let players = [];
      let room = null;
      let guesses = [];
      let curDigits = 4;
      let botLevel = 2; // 1=ç®€å• 2=æ™®é€š 3=å›°éš¾ï¼ˆé»˜è®¤ï¼‰

      // âœ… é˜²æ­¢â€œé‡å¤å¼¹çª—â€
      let lastWinRoomStatus = null;
      let lastWinnerId = null;

      const isHost = () => me_id && players.length>0 && players[0].id === me_id;
      const curTurnPlayer = () => players[(room?.turn_index||0)] || null;
      const targetOfIndex = (i) => players.length ? players[(i-1+players.length)%players.length] : null;
      const targetOfTurn = () => targetOfIndex(room?.turn_index||0);

      function applyDigitsToInputs(){
        $("#secretInput").maxLength = curDigits;
        $("#secretInput").value = digitsOnly($("#secretInput").value).slice(0, curDigits);

        $("#guessInput").maxLength = curDigits;
        $("#guessInput").placeholder = `${curDigits}ä½æ•°å­—`;
        $("#guessInput").value = digitsOnly($("#guessInput").value).slice(0, curDigits);

        $("#d3Btn").classList.toggle("active", curDigits===3);
        $("#d4Btn").classList.toggle("active", curDigits===4);
        $("#d5Btn").classList.toggle("active", curDigits===5);
      }

      function applyBotLevelUI(){
        $("#botEasyBtn").classList.toggle("active", botLevel===1);
        $("#botNormalBtn").classList.toggle("active", botLevel===2);
        $("#botHardBtn").classList.toggle("active", botLevel===3);
      }

      $("#secretInput").addEventListener("input", ()=> {
        $("#secretInput").value = digitsOnly($("#secretInput").value).slice(0, curDigits);
      });
      $("#guessInput").addEventListener("input", ()=> {
        $("#guessInput").value = digitsOnly($("#guessInput").value).slice(0, curDigits);
      });

      function renderHeader(){
        const cur = curTurnPlayer();
        const tgt = targetOfTurn();
        $("#mePill").textContent = me_id ? `Me: ${($("#nameInput").value||"").trim() || "(å·²åŠ å…¥)"}` : "Me";
        $("#turnPill").textContent = room ? `å›åˆï¼š${cur?cur.name:"?"}` : "å›åˆ";
        $("#targetPill").textContent = room ? `ç›®æ ‡ï¼š${tgt?tgt.name:"?"}` : "ç›®æ ‡";

        const canStart = isHost() && room?.status==="setup" && players.length>=2 && players.every(p=>p.ready);
        $("#startGameBtn").disabled = !canStart;

        const canReset = isHost();
        $("#resetRoomBtn").disabled = !canReset;

        // âœ… ç¡¬é™åˆ¶ï¼šåªæœ‰è½®åˆ°æˆ‘æ‰èƒ½è¾“å…¥+æäº¤
        const myTurn = cur && me_id && cur.id===me_id;
        const canGuess = room?.status==="playing" && myTurn;
        $("#guessBtn").disabled = !canGuess;
        $("#guessInput").disabled = !canGuess;

        $("#hintText").textContent =
          !room ? "ç­‰å¾…æˆ¿é—´åˆå§‹åŒ–..."
          : room.status==="setup"
              ? (players.every(p=>p.ready) ? "æˆ¿ä¸»å¯ä»¥å¼€å§‹æ¸¸æˆ" : "ç­‰å¾…æ‰€æœ‰äººæäº¤æ•°å­—")
          : room.status==="playing"
              ? (canGuess ? `è½®åˆ°ä½ çŒœä¸Šä¸€ä½ç©å®¶ï¼ˆ${curDigits}ä½ï¼‰` : "ç­‰å¾…å…¶ä»–ç©å®¶æ“ä½œ")
          : "æ¸¸æˆç»“æŸ";

        const canChangeDigitsFree = room?.status==="setup";
        const canChangeDigitsHost = isHost() && room?.status!=="setup";
        const enableDigitsBtns = canChangeDigitsFree || canChangeDigitsHost;
        $("#d3Btn").disabled = !enableDigitsBtns;
        $("#d4Btn").disabled = !enableDigitsBtns;
        $("#d5Btn").disabled = !enableDigitsBtns;

        // Botï¼šä»…æˆ¿ä¸» setup å¯æ·»åŠ ï¼›éš¾åº¦ä¹Ÿå»ºè®® setup æ‰èƒ½åˆ‡ï¼ˆç®€å•ç‚¹ï¼‰
        const bot = players.find(p=>p.is_bot===true);
        $("#addBotBtn").disabled = !(isHost() && room?.status==="setup" && !bot);

        const canSetBotLevel = isHost() && room?.status==="setup";
        $("#botEasyBtn").disabled = !canSetBotLevel;
        $("#botNormalBtn").disabled = !canSetBotLevel;
        $("#botHardBtn").disabled = !canSetBotLevel;

        applyBotLevelUI();
      }

      function renderColumns(){
        const cols = $("#cols");
        cols.innerHTML = "";

        for(let i=0;i<players.length;i++){
          const p = players[i];
          const tgt = targetOfIndex(i);

          const col = document.createElement("div");
          col.className = "col";
          col.id = `col_${p.id}`;
          if(room && room.status==="playing" && players[room.turn_index]?.id === p.id){
            col.classList.add("cur");
          }

          const head = document.createElement("div");
          head.className = "colHead";
          head.innerHTML = `
            <div>
              <div class="title">${p.name} çŒœ ${tgt?tgt.name:"?"}</div>
              <div class="sub">${p.ready ? `å·²æäº¤ï¼ˆ${curDigits}ä½ï¼‰` : "æœªå°±ç»ª"}</div>
            </div>
            <div class="sub" id="colStat_${p.id}">0 æ¬¡</div>
          `;
          const body = document.createElement("div");
          body.className = "colBody";
          body.id = `colBody_${p.id}`;

          col.appendChild(head);
          col.appendChild(body);
          cols.appendChild(col);
        }

        const cnt = {};
        for(const g of guesses){
          cnt[g.guesser_player_id] = (cnt[g.guesser_player_id]||0)+1;
          const body = document.getElementById(`colBody_${g.guesser_player_id}`);
          if(body){
            const line = document.createElement("span");
            if(g.score===curDigits) line.className="ok";
            line.textContent = `${g.guess}  => æŒ‰ä½æ­£ç¡® ${g.score} ä¸ª${g.score===curDigits?" âœ…":""}\n`;
            body.appendChild(line);
            body.scrollTop = body.scrollHeight;
          }
        }
        for(const p of players){
          const el = document.getElementById(`colStat_${p.id}`);
          if(el) el.textContent = `${cnt[p.id]||0} æ¬¡`;
        }
      }

      function maybeShowWinnerModal(){
        if(!room) return;
        if(room.status !== "ended") return;

        if(lastWinRoomStatus==="ended" && lastWinnerId===room.winner_id) return;
        lastWinRoomStatus = room.status;
        lastWinnerId = room.winner_id;

        const winner = players.find(p=>p.id===room.winner_id);
        if(!winner) return;

        if(me_id && room.winner_id === me_id){
          showModal("ğŸ‰æ­å–œä½ çŒœå¯¹å•¦ï¼", "ä½ èµ¢å•¦ï¼");
        } else {
          showModal("æ¸¸æˆç»“æŸ", `ğŸ‰ ${winner.name} çŒœä¸­å•¦ï¼`);
        }
      }

      async function fetchAll(){
        const r1 = await sb.from("rooms").select("*").eq("id", room_id).maybeSingle();
        room = r1.data || null;

        curDigits = room?.digits || 4;
        botLevel = room?.bot_level || 2;

        applyDigitsToInputs();
        applyBotLevelUI();

        const r2 = await sb.from("players").select("*").eq("room_id", room_id).order("joined_at");
        players = r2.data || [];

        const r3 = await sb.from("guesses").select("*").eq("room_id", room_id).order("created_at");
        guesses = r3.data || [];

        $("#gameCard").style.display = players.length>=2 ? "" : "none";
        const lvText = botLevel===1 ? "ç®€å•" : botLevel===2 ? "æ™®é€š" : "å›°éš¾";
        setLobby(`å½“å‰äººæ•°ï¼š${players.length} | å°±ç»ªï¼š${players.filter(p=>p.ready).length}/${players.length} | çŠ¶æ€ï¼š${room?room.status:"(æ— æˆ¿é—´)"} | ä½æ•°ï¼š${curDigits} | äººæœºéš¾åº¦ï¼š${lvText}`);

        renderHeader();
        renderColumns();
        maybeShowWinnerModal();

        await maybeBotTakeTurn();
      }

      function subscribeRealtime(){
        const ch = sb.channel(`room:${room_id}`);
        ch.on("postgres_changes", { event:"*", schema:"public", table:"rooms", filter:`id=eq.${room_id}` }, fetchAll);
        ch.on("postgres_changes", { event:"*", schema:"public", table:"players", filter:`room_id=eq.${room_id}` }, fetchAll);
        ch.on("postgres_changes", { event:"*", schema:"public", table:"guesses", filter:`room_id=eq.${room_id}` }, fetchAll);
        ch.subscribe();
      }

      async function ensureRoom(){
        const { error } = await sb.from("rooms").upsert(
          { id: room_id, status: "setup", turn_index: 0, player_count: 0, winner_id: null, digits: 4, bot_level: 2 },
          { onConflict: "id" }
        );
        if(error) throw error;
      }

      async function hardResetForDigitsChange(newDigits){
        await sb.from("guesses").delete().eq("room_id", room_id);
        await sb.from("players").update({ ready:false, secret_plain:null }).eq("room_id", room_id);
        await sb.from("rooms").update({ status:"setup", turn_index:0, winner_id:null, digits:newDigits }).eq("id", room_id);
        lastWinRoomStatus = null;
        lastWinnerId = null;
      }

      window.__setDigits = async (n) => {
        if(!room) return;
        if(![3,4,5].includes(n)) return;

        if(room.status !== "setup" && !isHost()){
          return alert("æ¸¸æˆè¿›è¡Œä¸­åªæœ‰æˆ¿ä¸»å¯ä»¥åˆ‡æ¢ä½æ•°ï¼ˆä¼šé‡ç½®æˆ¿é—´ï¼‰");
        }

        try{
          if(room.status === "setup"){
            const { error } = await sb.from("rooms").update({ digits:n }).eq("id", room_id);
            if(error) throw error;
          }else{
            const ok = confirm("åˆ‡æ¢ä½æ•°ä¼šé‡ç½®æˆ¿é—´ï¼ˆæ¸…ç©ºçŒœæµ‹å¹¶è¦æ±‚æ‰€æœ‰äººé‡æ–°æäº¤ï¼‰ã€‚ç¡®å®šå—ï¼Ÿ");
            if(!ok) return;
            await hardResetForDigitsChange(n);
          }
          addDebug("digits set to " + n);
          await fetchAll();
        }catch(e){
          console.error(e);
          alert("åˆ‡æ¢ä½æ•°å¤±è´¥ï¼š" + (e?.message||e));
        }
      };

      // ====== Bot éš¾åº¦è®¾ç½® ======
      window.__setBotLevel = async (lv) => {
        if(!room) return;
        if(![1,2,3].includes(lv)) return;
        if(!isHost() || room.status!=="setup") return alert("åªæœ‰æˆ¿ä¸»ä¸”åœ¨ setup é˜¶æ®µå¯ä»¥è®¾ç½®äººæœºéš¾åº¦");

        try{
          const { error } = await sb.from("rooms").update({ bot_level: lv }).eq("id", room_id);
          if(error) throw error;
          await fetchAll();
        }catch(e){
          console.error(e);
          alert("è®¾ç½®éš¾åº¦å¤±è´¥ï¼š" + (e?.message||e));
        }
      };

      // ç”Ÿæˆ/è¯»å–æœ¬æœºå”¯ä¸€ client_idï¼ˆæ¯å°è®¾å¤‡ä¸€ä¸ªï¼‰
      function getClientId(room_id){
        const k = `client_id:${room_id}`;
        let v = localStorage.getItem(k);
        if(!v){
          v = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2)));
          localStorage.setItem(k, v);
        }
        return v;
      }

      let joining = false;

      window.__joinRoom = async () => {
        if(joining) return;
        if(me_id) return alert("ä½ å·²ç»åŠ å…¥è¿‡è¿™ä¸ªæˆ¿é—´äº†ï¼ˆåˆ·æ–°é¡µé¢å³å¯ç»§ç»­ï¼‰ã€‚");

        const name = ($("#nameInput").value||"").trim();
        if(!name) return alert("è¯·è¾“å…¥åå­—");

        joining = true;
        $("#joinBtn").disabled = true;

        try{
          await ensureRoom();

          const client_id = getClientId(room_id);

          const existed = await sb
            .from("players")
            .select("*")
            .eq("room_id", room_id)
            .eq("client_id", client_id)
            .maybeSingle();

          if(existed.data){
            me_id = existed.data.id;
            localStorage.setItem(`me_player_id:${room_id}`, me_id);
            $("#mePill").textContent = `Me: ${existed.data.name}`;
            addDebug("join reuse existing player_id=" + me_id);
            await fetchAll();
            return;
          }

          const { data, error } = await sb
            .from("players")
            .insert({ room_id, name, client_id, is_bot:false, ready:false, secret_plain:null })
            .select("*")
            .single();
          if(error) throw error;

          me_id = data.id;
          localStorage.setItem(`me_player_id:${room_id}`, me_id);
          addDebug("join success, player_id=" + me_id);
          await fetchAll();
        }catch(e){
          console.error(e);
          addDebug("join failed: " + (e?.message||e));
          alert("åŠ å…¥å¤±è´¥ï¼š" + (e?.message||e));
        }finally{
          joining = false;
          $("#joinBtn").disabled = false;
        }
      };

      window.__setSecret = async () => {
        if(!me_id) return alert("è¯·å…ˆåŠ å…¥æˆ¿é—´");
        let s = digitsOnly($("#secretInput").value).slice(0, curDigits);
        $("#secretInput").value = s;
        if(!isNDigits(s, curDigits)) return alert(`è¯·è¾“å…¥å®Œæ•´${curDigits}ä½æ•°å­—`);

        try{
          const { error } = await sb.from("players").update({ secret_plain: s, ready: true }).eq("id", me_id);
          if(error) throw error;
          $("#secretHint").textContent = `âœ… å·²æäº¤ç§˜å¯†ï¼ˆ${curDigits}ä½ï¼Œready=trueï¼‰`;
          addDebug("setSecret success");
          await fetchAll();
        }catch(e){
          console.error(e);
          addDebug("setSecret failed: " + (e?.message||e));
          alert("æäº¤å¤±è´¥ï¼š" + (e?.message||e));
        }
      };

      window.__startGame = async () => {
        if(!isHost()) return alert("åªæœ‰æˆ¿ä¸»å¯ä»¥å¼€å§‹");
        if(players.length<2) return alert("è‡³å°‘2äºº");
        if(players.some(p=>!p.ready)) return alert("è¿˜æœ‰äººæ²¡æäº¤æ•°å­—");

        try{
          const { data, error } = await sb
            .from("rooms")
            .update({ status:"playing", turn_index:0, winner_id:null })
            .eq("id", room_id)
            .select("*")
            .single();
          if(error) throw error;

          addDebug("game started âœ… status=" + data.status);
          await fetchAll();
        }catch(e){
          console.error(e);
          addDebug("start failed: " + (e?.message||e));
          alert("å¼€å§‹å¤±è´¥ï¼š" + (e?.message||e));
        }
      };

      window.__resetRoom = async () => {
        if(!isHost()) return alert("åªæœ‰æˆ¿ä¸»å¯ä»¥é‡ç½®");
        try{
          await sb.from("guesses").delete().eq("room_id", room_id);
          await sb.from("players").update({ ready:false, secret_plain:null }).eq("room_id", room_id);
          await sb.from("rooms").update({ status:"setup", turn_index:0, winner_id:null }).eq("id", room_id);
          addDebug("room reset");
          lastWinRoomStatus = null;
          lastWinnerId = null;
          await fetchAll();
        }catch(e){
          console.error(e);
          alert("é‡ç½®å¤±è´¥ï¼š" + (e?.message||e));
        }
      };

      window.__submitGuess = async () => {
        if(!room || room.status!=="playing") return;

        const cur = curTurnPlayer();
        if(!cur || cur.id!==me_id){
          return alert("è¿˜æ²¡è½®åˆ°ä½ ");
        }

        let guess = digitsOnly($("#guessInput").value).slice(0, curDigits);
        $("#guessInput").value = guess;
        if(!isNDigits(guess, curDigits)) return alert(`è¯·è¾“å…¥å®Œæ•´${curDigits}ä½æ•°å­—`);

        const target = targetOfTurn();
        if(!target) return;

        if(!target.secret_plain || !isNDigits(target.secret_plain, curDigits)){
          return alert(`ç›®æ ‡ç©å®¶è¿˜æ²¡æäº¤${curDigits}ä½æ•°å­—`);
        }

        const score = scoreExactN(target.secret_plain, guess);

        try{
          const { error } = await sb.from("guesses").insert({
            room_id,
            turn_index: room.turn_index||0,
            guesser_player_id: cur.id,
            target_player_id: target.id,
            guess,
            score
          });
          if(error) throw error;

          if(score===curDigits){
            showModal("ğŸ‰æ­å–œä½ çŒœå¯¹å•¦ï¼", "ä½ èµ¢å•¦ï¼");
            await sb.from("rooms").update({ status:"ended", winner_id: cur.id }).eq("id", room_id);
          }else{
            const nextTurn = ((room.turn_index||0)+1) % players.length;
            await sb.from("rooms").update({ turn_index: nextTurn }).eq("id", room_id);
          }
          $("#guessInput").value="";
        }catch(e){
          console.error(e);
          alert("æäº¤çŒœæµ‹å¤±è´¥ï¼š" + (e?.message||e));
        }
      };

      // =======================
      // âœ… äººæœºï¼ˆBotï¼‰+ éš¾åº¦
      // =======================
      function getBot(){
        return players.find(p=>p.is_bot===true) || null;
      }

      // easy: å®Œå…¨éšæœº
      function botPickEasy(){
        const max = Math.pow(10, curDigits);
        return padNum(Math.floor(Math.random()*max), curDigits);
      }

      // normal: éšæœºæŠ½æ · + çº¦æŸæ£€æŸ¥ï¼ˆä¸å¡é¡¿ï¼‰
      function botPickNormal(botId, targetId){
        const hist = guesses.filter(g => g.guesser_player_id===botId && g.target_player_id===targetId);
        const max = Math.pow(10, curDigits);
        const tries = curDigits===5 ? 15000 : 6000;

        for(let t=0;t<tries;t++){
          const cand = padNum(Math.floor(Math.random()*max), curDigits);
          let ok=true;
          for(const h of hist){
            if(scoreExactN(cand, h.guess) !== h.score){ ok=false; break; }
          }
          if(ok) return cand;
        }
        return botPickEasy();
      }

      // hard: å…¨é‡æšä¸¾å€™é€‰ï¼ˆ5ä½æœ€å¤š100000ï¼Œå¯æ¥å—ï¼‰
      function botPickHard(botId, targetId){
        const hist = guesses.filter(g => g.guesser_player_id===botId && g.target_player_id===targetId);
        const max = Math.pow(10, curDigits);

        const candidates = [];
        for(let x=0; x<max; x++){
          const cand = padNum(x, curDigits);
          let ok=true;
          for(const h of hist){
            if(scoreExactN(cand, h.guess) !== h.score){ ok=false; break; }
          }
          if(ok) candidates.push(cand);
        }
        if(candidates.length===0) return botPickEasy();
        return candidates[Math.floor(Math.random()*candidates.length)];
      }

      let botActing = false;
      let lastBotActionKey = "";

      async function maybeBotTakeTurn(){
        // åªè®©æˆ¿ä¸»é©±åŠ¨ bot
        if(!isHost()) return;
        if(!room || room.status!=="playing") return;

        const cur = curTurnPlayer();
        if(!cur || !cur.is_bot) return;

        const bot = cur;
        const target = targetOfTurn();
        if(!target) return;

        if(!target.secret_plain || !isNDigits(target.secret_plain, curDigits)) return;

        // é˜²é‡å¤
        const key = `${room_id}|turn=${room.turn_index}|g=${guesses.length}|bot=${bot.id}`;
        if(key === lastBotActionKey) return;
        if(botActing) return;

        botActing = true;
        lastBotActionKey = key;

        try{
          // ä¸åŒéš¾åº¦ä¸åŒâ€œæ€è€ƒæ—¶é—´â€
          const delay = botLevel===1 ? 350 : botLevel===2 ? 650 : 900;
          await new Promise(r=>setTimeout(r, delay));

          let guess;
          if(botLevel===1) guess = botPickEasy();
          else if(botLevel===2) guess = botPickNormal(bot.id, target.id);
          else guess = botPickHard(bot.id, target.id);

          const score = scoreExactN(target.secret_plain, guess);

          const { error } = await sb.from("guesses").insert({
            room_id,
            turn_index: room.turn_index||0,
            guesser_player_id: bot.id,
            target_player_id: target.id,
            guess,
            score
          });
          if(error) throw error;

          if(score===curDigits){
            await sb.from("rooms").update({ status:"ended", winner_id: bot.id }).eq("id", room_id);
          }else{
            const nextTurn = ((room.turn_index||0)+1) % players.length;
            await sb.from("rooms").update({ turn_index: nextTurn }).eq("id", room_id);
          }
        }catch(e){
          console.error(e);
          addDebug("bot failed: " + (e?.message||e));
        }finally{
          botActing = false;
        }
      }

      window.__addBot = async () => {
        if(!room) return;
        if(!isHost()) return alert("åªæœ‰æˆ¿ä¸»å¯ä»¥æ·»åŠ äººæœº");
        if(room.status!=="setup") return alert("è¯·åœ¨å¼€å§‹æ¸¸æˆå‰ï¼ˆsetupï¼‰æ·»åŠ äººæœº");
        if(getBot()) return alert("æˆ¿é—´é‡Œå·²ç»æœ‰äººæœºäº†");

        try{
          const botSecret = randDigits(curDigits);

          const { data, error } = await sb
            .from("players")
            .insert({
              room_id,
              name: "ğŸ¤– Bot",
              is_bot: true,
              ready: true,
              secret_plain: botSecret,
              client_id: `BOT_${room_id}`
            })
            .select("*")
            .single();

          if(error){
            const existed = await sb.from("players").select("*")
              .eq("room_id", room_id).eq("client_id", `BOT_${room_id}`).maybeSingle();
            if(existed.data){
              alert("äººæœºå·²å­˜åœ¨ ğŸ¤–");
              await fetchAll();
              return;
            }
            throw error;
          }

          addDebug("bot added: " + data.id);
          alert("å·²æ·»åŠ äººæœº ğŸ¤–ï¼ˆå®ƒå·²è‡ªåŠ¨æäº¤ç§˜å¯†ï¼‰");
          await fetchAll();
        }catch(e){
          console.error(e);
          alert("æ·»åŠ äººæœºå¤±è´¥ï¼š" + (e?.message||e));
        }
      };

      // bind buttons
      $("#joinBtn").onclick = window.__joinRoom;
      $("#setSecretBtn").onclick = window.__setSecret;
      $("#startGameBtn").onclick = window.__startGame;
      $("#resetRoomBtn").onclick = window.__resetRoom;
      $("#guessBtn").onclick = window.__submitGuess;

      $("#d3Btn").onclick = ()=>window.__setDigits(3);
      $("#d4Btn").onclick = ()=>window.__setDigits(4);
      $("#d5Btn").onclick = ()=>window.__setDigits(5);

      $("#addBotBtn").onclick = window.__addBot;
      $("#botEasyBtn").onclick = ()=>window.__setBotLevel(1);
      $("#botNormalBtn").onclick = ()=>window.__setBotLevel(2);
      $("#botHardBtn").onclick = ()=>window.__setBotLevel(3);

      // å¯åŠ¨ï¼ˆä½ åŸæ¥çš„å»¶è¿Ÿè¿æ¥ï¼‰
      setLobby("é¡µé¢å·²åŠ è½½ã€‚å‡†å¤‡è¿æ¥æœåŠ¡å™¨â€¦ï¼ˆæ‰‹æœºç½‘ç»œæ…¢çš„è¯ç­‰å‡ ç§’ï¼‰");

      setTimeout(async () => {
        try {
          await ensureRoom();
          await fetchAll();
        } catch (e) {
          console.error(e);
          setLobby("âš ï¸ æœåŠ¡å™¨è¿æ¥å¤±è´¥/å¾ˆæ…¢ï¼šä½ ä»å¯å¤åˆ¶é“¾æ¥ã€‚ç¨åå†è¯•åˆ·æ–°ã€‚");
          addDebug("boot failed: " + (e?.message || e));
          return;
        }

        setTimeout(() => {
          try { subscribeRealtime(); }
          catch (e) { console.error(e); addDebug("realtime failed: " + (e?.message||e)); }
        }, 800);
      }, 300);
    });
  })();
  </script>
</head>

<body>
<div class="wrap">
  <h1>çŒœæ•°å­—</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span class="pill" id="roomPill">Room</span>
        <span class="pill" id="mePill">Me</span>
        <span class="pill" id="statusPill">Status</span>
      </div>
      <div class="row">
        <button id="d3Btn" class="ghost">3ä½</button>
        <button id="d4Btn" class="ghost active">4ä½</button>
        <button id="d5Btn" class="ghost">5ä½</button>
        <button id="copyLinkBtn" onclick="window.__copyRoomLink()">å¤åˆ¶æˆ¿é—´é“¾æ¥</button>
        <button class="danger" id="leaveBtn" onclick="window.__leaveRoom()">é€€å‡ºæˆ¿é—´</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label class="muted">ä½ çš„åå­—</label>
      <input id="nameInput" class="small" placeholder="ä¾‹å¦‚ A" />
      <button id="joinBtn" class="primary">åŠ å…¥æˆ¿é—´</button>
      <span class="muted" id="joinHint"></span>
    </div>

    <div class="row" style="margin-top:10px">
      <label class="muted">è®¾ç½®ä½ çš„æ•°å­—</label>
      <input id="secretInput" class="small" placeholder="ä¾‹å¦‚ 0854" maxlength="4" inputmode="numeric" autocomplete="off" />
      <button id="setSecretBtn" class="primary">æäº¤ç§˜å¯†</button>
      <span class="muted" id="secretHint"></span>
    </div>

    <div class="hr"></div>
    <div class="muted" id="lobbyInfo"></div>
    <div class="debug" id="debugBar">debug: (loading...)</div>
  </div>

  <div class="card" id="gameCard" style="display:none;">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span class="pill" id="turnPill">å›åˆ</span>
        <span class="pill" id="targetPill">ç›®æ ‡</span>
      </div>
      <div class="row">
        <button id="botEasyBtn" class="ghost">ç®€å•</button>
        <button id="botNormalBtn" class="ghost active">æ™®é€š</button>
        <button id="botHardBtn" class="ghost">å›°éš¾</button>
        <button id="addBotBtn" class="ghost">æ·»åŠ äººæœº ğŸ¤–</button>
        <button id="startGameBtn" class="primary">æˆ¿ä¸»å¼€å§‹</button>
        <button id="resetRoomBtn" class="danger">é‡ç½®æˆ¿é—´</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label>è¾“å…¥çŒœæµ‹</label>
      <input id="guessInput" class="small" placeholder="4ä½æ•°å­—" maxlength="4" inputmode="numeric" autocomplete="off" />
      <button id="guessBtn" class="primary">æäº¤çŒœæµ‹</button>
      <span class="muted" id="hintText"></span>
    </div>

    <div class="hr"></div>
    <div id="cols" class="cols"></div>
  </div>

</div>

<!-- âœ… èƒœåˆ©å¼¹çª— -->
<div class="modalMask" id="modalMask">
  <div class="modal">
    <div class="modalTitle" id="modalTitle">ğŸ‰æ­å–œä½ çŒœå¯¹å•¦ï¼</div>
    <div class="modalSub" id="modalSub"></div>
    <button class="modalBtn" id="modalOk">ç¡®å®š</button>
  </div>
</div>

</body>
</html>
